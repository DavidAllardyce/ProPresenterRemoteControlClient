<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentation Slide List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"
        onError="this.onError=null;this.href='bootstrap.min.css';">
    <style>
        .thumbnail-container {
            position: relative;
        }

        .slide-index {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .thumbnail-item {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .thumbnail-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .thumbnail-item.active {
            border: 3px solid #0d6efd;
        }
    </style>
</head>

<body>
    <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
        <symbol id="bi-refresh" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
            <path
                d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
        </symbol>
        <symbol fill="currentColor" id="bi-arrow-left-circle" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z" />
        </symbol>
        <symbol fill="currentColor" id="bi-arrow-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
        </symbol>
        <symbol fill="currentColor" id="bi-house" viewBox="0 0 16 16">
            <path
                d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z" />
        </symbol>
        <symbol fill="currentColor" id="bi-check2-circle" viewBox="0 0 16 16">
            <path
                d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0" />
            <path
                d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z" />
        </symbol>
        <symbol fill="currentColor" id="bi-image-fill" viewBox="0 0 16 16">
            <path
                d="M.002 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-12a2 2 0 0 1-2-2zm1 9v1a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V9.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062zm5-6.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0" />
        </symbol>
    </svg>
    <div class="container-fluid">

        <div class="row mt-2 bg-light">
            <div class="col-12">
                <div id="controlBar" class="mb-3">
                    <div class="input-group">
                        <a href="index.html" class="btn btn-outline-secondary m-auto" title="Back to Control Panel">
                            <svg class="bi" width="32" height="32" style="position: relative;">
                                <use xlink:href="#bi-house" width="28" height="28" />
                                <use xlink:href="#bi-arrow-left" width="16" height="16" x="6" y="8" />
                            </svg>
                        </a>
                        <div class="form-floating">
                            <select class="form-select" id="presentationSelect" aria-label="Select Presentation">
                                <option value="active" selected>Active Presentation</option>
                                <!-- Other presentations will be loaded here -->
                            </select>
                            <label for="presentationSelect">Presentation</label>
                        </div>
                        
                        <button id="menuQualitySelection" class="btn btn-outline-primary dropdown-toggle" type="button"
                            title="Select image quality" data-bs-toggle="dropdown" aria-expanded="false">
                            <svg class="bi" width="16" height="16">
                                <use xlink:href="#bi-image-fill" />
                            </svg>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-quality="400">Low Quality</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="600">Good Quality</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="800">Better Quality</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="1200">Best Quality</a></li>
                        </ul>
                        <button id="refreshButton" class="btn btn-outline-primary" title="Refresh thumbnails">
                            <svg class="bi" width="16" height="16">
                                <use xlink:href="#bi-refresh" />
                            </svg>
                        </button>
                        <div class="input-group-text ms-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="triggerOnClickToggle" unchecked>
                                <label class="form-check-label" for="triggerOnClickToggle">Change slides on
                                    click</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row bg-light">
            <div class="col-12 border-bottom text-start">
                <span class="text-muted small">Slide Thumbnails for:</span>
                <h1 id="presentationTitle" class="text-start display-6">Loading presentation...</h1>

            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="thumbnailGrid" class="row row-cols-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3">
                    <!-- Thumbnails will be populated here -->
                    <div class="col placeholder-glow">
                        <div class="card h-100">
                            <div class="card-body">
                                <span class="placeholder col-12" style="height: 150px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading thumbnails...</p>
        </div>
    </div>

    <script>
        let isConnected = false;
        let currentPresentation = null;
        let activeSlideIndex = null;
        let triggerOnClick = false;
        let selectedQuality = 600;

        document.addEventListener('DOMContentLoaded', async function () {
            // Check if we have a connection
            const baseUrl = localStorage.getItem('baseUrl');
            if (!baseUrl) {
                showError('No connection configured. Please go back to the main page and configure your connection.');
                return;
            }

            try {
                // Attempt connection
                const response = await fetch(`${baseUrl}/version`);
                if (response.ok) {
                    isConnected = true;
                    await loadPresentationListFromPlaylist(document.getElementById('presentationSelect'), undefined, baseUrl);
                    await loadAllSlideThumbnails();
                } else {
                    showError('Failed to connect to ProPresenter API');
                }
            } catch (error) {
                showError(`Connection error: ${error.message}`);
            }

            // Set quality select from localStorage
            const quality = localStorage.getItem('quality');
            if (quality) {
                selectedQuality = quality;
                // make the quality selection in the dropdown text bold for the selected value
                document.querySelectorAll('.dropdown-menu a').forEach(item => {
                    if (item.getAttribute('data-quality') === quality) {
                        item.classList.add('fw-semibold');
                    }
                });
            }

            // Setup trigger on click toggle
            //const savedTriggerSetting = localStorage.getItem('triggerOnClick');
            //triggerOnClick = savedTriggerSetting !== 'false';
            document.getElementById('triggerOnClickToggle').checked = triggerOnClick;

            document.getElementById('triggerOnClickToggle').addEventListener('change', function () {
                triggerOnClick = this.checked;
                //localStorage.setItem('triggerOnClick', triggerOnClick);
            });

            // Setup refresh button handler
            document.getElementById('refreshButton').addEventListener('click', async function () {
                await loadAllSlideThumbnails();
            });

            // Setup presentation select handler
            document.getElementById('presentationSelect').addEventListener('change', function () {
                loadAllSlideThumbnails();
            });

            // Setup menu quality selection handler
            document.querySelectorAll('.dropdown-menu a').forEach(item => {

                item.addEventListener('click', function (event) {
                    event.preventDefault();
                    const quality = this.getAttribute('data-quality');
                    this.classList.add('fw-semibold');
                    selectedQuality = quality;
                    localStorage.setItem('quality', quality);
                    loadAllSlideThumbnails();

                    // Remove bold text from other items
                    document.querySelectorAll('.dropdown-menu a').forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.classList.remove('fw-semibold');
                        }
                    });
                });
            });
        });

        async function loadAllSlideThumbnails() {
            const thumbnailGrid = document.getElementById('thumbnailGrid');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Show loading indicator
            loadingIndicator.style.display = 'block';
            thumbnailGrid.innerHTML = '';

            try {
                const baseUrl = localStorage.getItem('baseUrl');
                const quality = selectedQuality;
                const selectedPresentationId = document.getElementById('presentationSelect').value;

                // Load the selected presentation
                const response = await fetch(`${baseUrl}/v1/presentation/${selectedPresentationId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const presentation = data.presentation;
                document.getElementById('presentationTitle').textContent = presentation.id.name;

                if (!presentation) {
                    showError('No presentation available');
                    return;
                }

                const active_slide = await fetch(`${baseUrl}/v1/presentation/slide_index`)
                    .then(async response => await response.json())
                    .catch(error => {
                        console.error('Error:', error);
                    });

                if (active_slide && active_slide.presentation_index) {
                    activeSlideIndex = active_slide.presentation_index.index;
                }

                let slideIndex = 0;

                // Rest of your existing code for loading thumbnails...
                for (const group of presentation.groups) {
                    // Create a group header
                    // const groupHeader = document.createElement('div');
                    // groupHeader.className = 'col-12 mb-2 mt-4';
                    // groupHeader.innerHTML = `<h5 class="border-bottom pb-2">${group.name}</h5>`;
                    // thumbnailGrid.appendChild(groupHeader);

                    for (const slide of group.slides) {
                        if (slide.enabled) {
                            // Create column container
                            const col = document.createElement('div');
                            col.className = 'col';

                            // Create thumbnail container
                            const thumbnailContainer = document.createElement('div');
                            thumbnailContainer.className = 'card h-100 thumbnail-item';
                            if (currentPresentation && presentation.id.uuid === currentPresentation.id.uuid && slideIndex === activeSlideIndex) {
                                thumbnailContainer.classList.add('active');
                            }
                            thumbnailContainer.dataset.index = slideIndex;

                            // Create loading placeholder
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder-glow card-body p-0';
                            placeholder.innerHTML = '<span class="placeholder col-12" style="height: 150px;"></span>';

                            // Create image element (initially hidden)
                            const img = document.createElement('img');
                            img.className = 'card-img-top d-none';
                            img.alt = `Slide ${slideIndex + 1}`;

                            // Create slide index badge
                            const indexBadge = document.createElement('div');
                            indexBadge.classList.add('slide-index');
                            if (currentPresentation && presentation.id.uuid === currentPresentation.id.uuid && slideIndex === activeSlideIndex) {
                                indexBadge.classList.add('bg-light');
                                indexBadge.classList.add('text-dark');
                                indexBadge.classList.add('opacity-75');
                            }

                            indexBadge.textContent = slideIndex + 1;

                            // Create card body for notes/text
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body p-2';

                            // Create caption
                            const caption = document.createElement('p');
                            caption.className = 'card-text small text-truncate';
                            if (slide.notes) {
                                caption.textContent = slide.notes.substring(0, 30);
                                caption.title = slide.notes;
                            } else if (slide.text) {
                                caption.textContent = slide.text.substring(0, 30);
                                caption.title = slide.text;
                            } else {
                                caption.textContent = `Slide ${slideIndex + 1}`;
                            }

                            // Assemble thumbnail
                            cardBody.appendChild(caption);
                            thumbnailContainer.appendChild(placeholder);
                            thumbnailContainer.appendChild(img);
                            thumbnailContainer.appendChild(indexBadge);
                            thumbnailContainer.appendChild(cardBody);
                            col.appendChild(thumbnailContainer);
                            thumbnailGrid.appendChild(col);

                            // Add click event to trigger slide
                            thumbnailContainer.addEventListener('click', async function () {
                                const clickedIndex = parseInt(this.dataset.index);

                                // Only trigger the slide if the toggle is enabled
                                if (triggerOnClick) {
                                    await triggerSlide(clickedIndex);
                                }

                                // Update active status regardless of triggering
                                document.querySelectorAll('.thumbnail-item.active').forEach(el => {
                                    el.classList.remove('active');
                                });

                                this.classList.add('active');
                            });

                            // Load the thumbnail image
                            const url = `${baseUrl}/v1/presentation/${presentation.id.uuid}/thumbnail/${slideIndex}?quality=${quality}`;
                            await loadThumbnail(url, img, placeholder);
                        }

                        slideIndex++;
                    }
                }

                // Hide loading indicator
                loadingIndicator.style.display = 'none';

            } catch (error) {
                showError(`Failed to load thumbnails: ${error.message}`);
                loadingIndicator.style.display = 'none';
            }
        }

        async function loadThumbnail(url, imgElement, placeholder) {
            try {
                const response = await fetch(url);

                if (response.ok) {
                    const blob = await response.blob();
                    const imgUrl = URL.createObjectURL(blob);
                    imgElement.src = imgUrl;
                    imgElement.classList.remove('d-none');
                    placeholder.classList.add('d-none');
                } else {
                    console.error(`Failed to load thumbnail: ${response.status}`);
                    placeholder.innerHTML = '<div class="alert alert-warning m-2">Thumbnail not available</div>';
                }
            } catch (error) {
                console.error(`Error loading thumbnail: ${error.message}`);
                placeholder.innerHTML = '<div class="alert alert-danger m-2">Error loading thumbnail</div>';
            }
        }

        async function loadPresentationListFromPlaylist(listElement, id, baseUrl) {

            let isActivePlaylist = false;

            try {
                if (baseUrl === undefined) {
                    baseUrl = localStorage.getItem('baseUrl');
                }

                const active_playlist = await fetch(`${baseUrl}/v1/playlist/active`)
                    .then(async response => await response.json())
                    .catch(error => {
                        console.error('Error:', error);
                    });

                if (id === undefined && active_playlist && active_playlist.presentation.playlist) {
                    id = active_playlist.presentation.playlist.uuid;
                }

                if (id !== undefined) {

                    if (active_playlist && active_playlist.presentation.playlist) {
                        isActivePlaylist = active_playlist.presentation.playlist.uuid === id;
                    }

                    if (currentPresentation == undefined) {
                        const active_presentation = await fetch(`${baseUrl}/v1/presentation/active`)
                            .then(async response => await response.json())
                            .catch(error => {
                                console.error('Error:', error);
                            });

                        if (active_presentation && active_presentation.presentation) {
                            currentPresentation = active_presentation.presentation;
                        }
                    }

                    const playlistItems = await fetch(`${baseUrl}/v1/playlist/${id}`)
                        .then(async response => await response.json())
                        .catch(error => {
                            console.error('Error:', error);
                        });

                    if (playlistItems !== undefined) {

                        listElement.innerHTML = '';

                        playlistItems.items.forEach(item => {
                            if (item.type !== 'presentation') {
                                return;
                            }

                            const option = document.createElement('option');
                            option.value = item.id.uuid;
                            option.innerHTML = item.id.name;
                            if (currentPresentation && item.id.uuid === currentPresentation.id.uuid) {
                                option.classList.add('fw-semibold');
                                option.selected = true;
                            }
                            listElement.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error(`Error loading playlist: ${error.message}`);
            }
        }

        async function triggerSlide(slideIndex) {
            try {
                const baseUrl = localStorage.getItem('baseUrl');

                if (baseUrl === undefined) {
                    showError('No connection configured. Please go back to the main page and configure your connection.');
                    return;
                }

                const selected_presentation_id = document.getElementById('presentationSelect').value;
                if (currentPresentation && selected_presentation_id !== currentPresentation.id.uuid) {
                    console.log('Selected presentation does not match active presentation');
                    return;
                }

                const url = `${baseUrl}/v1/presentation/active/${slideIndex}/trigger`;

                const response = await fetch(url, {
                    method: 'GET',
                });

                if (response.ok) {
                    console.log(`Triggered slide ${slideIndex + 1}`);
                    activeSlideIndex = slideIndex;
                } else {
                    console.error(`Failed to trigger slide: ${response.status}`);
                }
            } catch (error) {
                console.error(`Error triggering slide: ${error.message}`);
            }
        }

        function showError(message) {
            const thumbnailGrid = document.getElementById('thumbnailGrid');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.style.display = 'none';
            thumbnailGrid.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        ${message}
                    </div>
                </div>
            `;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"
        onError="this.onError=null;this.src='bootstrap.min.js';"></script>
</body>

</html>