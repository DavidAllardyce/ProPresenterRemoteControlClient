<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPresenter Remote Control Client</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"
        onError="this.onError=null;this.href='bootstrap.min.css';">
    <style>
        .configBtn:focus {
            outline: none;
        }
    </style>
</head>

<body>
    <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
        <symbol id="bi-house-slash" viewBox="0 0 24 24" fill="currentColor">
            <path
                d="M13.879 10.414a2.5 2.5 0 0 0-3.465 3.465zm.707.707-3.465 3.465a2.501 2.501 0 0 0 3.465-3.465m-4.56-1.096a3.5 3.5 0 1 1 4.949 4.95 3.5 3.5 0 0 1-4.95-4.95Z" />
            <path
                d="M7.293 1.5a1 1 0 0 1 1.414 0L11 3.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.293l2.354 2.353a.5.5 0 0 1-.708.708L8 2.207l-5 5V13.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 2 13.5V8.207l-.646.647a.5.5 0 1 1-.708-.708z" />
        </symbol>
        <symbol id="bi-house-fill" viewBox="0 0 24 24" fill="currentColor">
            <path
                d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z" />
            <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z" />
        </symbol>
        <symbol id="bi-caret-left" viewBox="0 0 16 16" fill="currentColor">
            <path
                d="M11.354 1.646a.5.5 0 0 1 0 .708L6.707 8l4.647 4.646a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 0 1 .708 0z" />
        </symbol>
        <symbol id="bi-caret-right-fill" viewBox="0 0 16 16" fill="currentColor">
            <path
                d="M4.354 1.646a.5.5 0 0 1 .708 0l5 5a.5.5 0 0 1 0 .708l-5 5a.5.5 0 0 1-.708-.708L9.293 8 4.354 3.354a.5.5 0 0 1 0-.708z" />
        </symbol>
        <symbol id="bi-lock" viewBox="0 0 16 16" fill="currentColor">
            <path
                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1" />
        </symbol>
        <symbol id="bi-unlock" viewBox="0 0 16 16" fill="currentColor">
            <path
                d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2M3 8a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1z" />
        </symbol>
        <symbol id="bi-view-list" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3 4.5h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2m0 1a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1zM1 2a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 2m0 12a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 14"/>
        </symbol>
        <symbol fill="currentColor" id="bi-list-ol" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5"/>
            <path d="M1.713 11.865v-.474H2c.217 0 .363-.137.363-.317 0-.185-.158-.31-.361-.31-.223 0-.367.152-.373.31h-.59c.016-.467.373-.787.986-.787.588-.002.954.291.957.703a.595.595 0 0 1-.492.594v.033a.615.615 0 0 1 .569.631c.003.533-.502.8-1.051.8-.656 0-1-.37-1.008-.794h.582c.008.178.186.306.422.309.254 0 .424-.145.422-.35-.002-.195-.155-.348-.414-.348h-.3zm-.004-4.699h-.604v-.035c0-.408.295-.844.958-.844.583 0 .96.326.96.756 0 .389-.257.617-.476.848l-.537.572v.03h1.054V9H1.143v-.395l.957-.99c.138-.142.293-.304.293-.508 0-.18-.147-.32-.342-.32a.33.33 0 0 0-.342.338zM2.564 5h-.635V2.924h-.031l-.598.42v-.567l.629-.443h.635z"/>
        </symbol>
    </svg>

    <button id="configButton"
        class="position-absolute top-0 start-0 mt-3 ms-2 border-0 bg-transparent shadow-none configBtn"
        title="Open Configuration"
        data-bs-toggle="offcanvas" data-bs-target="#urlConfig" aria-controls="urlConfig">
        <svg id="configButtonIcon" class="bi text-warning" height="36" width="36">
            <use xlink:href="#bi-house-slash"></use>
        </svg>
    </button>

    <a href="list.html" id="listPageButton"
        class="position-absolute top-0 start-0 mt-5 pt-4 ms-2 border-0 bg-transparent shadow-none"
        title="View Slide List" style="opacity: 0.5;"
        onmouseover="this.style.opacity=1;" onmouseout="this.style.opacity=0.5;">
        <svg class="bi text-primary" height="36" width="36">
            <use xlink:href="#bi-list-ol"></use>
        </svg>
    </a>

    <div class="container ms-5">
        <!-- Content -->
        <main id="content" class="content">

            <div class="row bg-light">
                <div class="col-12 border-bottom text-start">
                    <span class="text-muted small">Now Showing:</span>
                    <h1 id="appTitle" class="text-start display-5">ProPresenter Control App</h1>
                </div>
            </div>

            <div class="row mt-3">
                <div class="card-group p-0">
                    <div class="card border-info border-2">
                        <div class="card-header border-info text-start">
                            <div class="card-title lead">Active Slide</div>
                        </div>
                        <div class="card-body placeholder-glow">
                            <span id="slideThumbnailPlaceholder" class="placeholder col-12"></span>
                            <img id="slideThumbnail" alt="Active slide thumbnail will appear here"
                                class="img-fluid d-none" />
                        </div>
                        <div class="card-footer mt-2 bg-light border-info">
                            <div class="row">
                                <div class="col mt-auto">
                                    <button id="previousButton" class="btn btn-sm btn-warning mt-auto m-2">
                                        <svg class="bi" height="20" width="20">
                                            <use xlink:href="#bi-caret-left"></use>
                                        </svg> Back
                                    </button>
                                </div>
                                <div class="col mt-auto">
                                    <p id="slideIndexLabel" class="lead text-center">Slide: 1</p>
                                </div>
                                <div class="col mt-auto">
                                    <button id="nextButton" class="btn btn-sm btn-success mt-auto m-2 float-end">Next
                                        <svg class="bi" height="20" width="20">
                                            <use xlink:href="#bi-caret-right-fill"></use>
                                        </svg></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-info border-0 mx-1">
                        <div class="card-header border-0 text-start">
                            <div class="card-title lead">Notes</div>
                        </div>
                        <div class="card-body">
                            <p id="slideNotes" class="card-text overflow-auto">

                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="card border-secondary border-0 mt-2 w-25">
                    <div class="card-header border-0 text-start">
                        <div class="card-title lead text-center"><em>Next Slide Preview</em></div>
                    </div>
                    <div class="card-body placeholder-glow">
                        <span id="nextSlideThumbnailPlaceholder" class="placeholder col-12"></span>
                        <img id="nextSlideThumbnail" alt="Next slide thumbnail will appear here"
                            class="img-fluid img-thumbnail d-none m-1" />
                    </div>
                </div>
                <div class="card border-primary border-0 w-auto mt-2 ms-2">
                    <div class="card-header border-0 text-start">
                        <div class="card-title lead text-start">Program Order</div>
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <div class="form-floating">
                                <select class="form-select" disabled id="presentationList"
                                    aria-label="Active presentation selection">
                                </select>
                                <label for="presentationList">Active Presentation</label>
                            </div>
                            <input type="checkbox" class="btn-check" checked id="btnPresentationListLock"
                                autocomplete="off">
                            <label id="btnPresentationListLockIcon"
                                class="btn d-flex align-items-center justify-content-center"
                                for="btnPresentationListLock">
                                <svg class="bi" height="20" width="20">
                                    <use xlink:href="#bi-lock"></use>
                                </svg>
                            </label>
                        </div>
                        <div class="mt-3 border-top pt-2">
                            <span class="text-muted">Next Up:</span>
                            <h5 id="nextPresentation" class="d-inline-block ms-2">-</h5>
                            <button id="startNextButton" disabled class="btn btn-outline-primary btn-sm ms-2">
                                <svg class="bi" height="16" width="16">
                                    <use xlink:href="#bi-caret-right-fill"></use>
                                </svg>
                                Start
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Offcanvas Configuration -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="urlConfig" aria-labelledby="urlConfigLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="urlConfigLabel">Configuration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <h5 class="mb-3">Network</h5>
            <div class="form-floating mb-3">
                <select class="form-select" id="protocolSelect" aria-label="Protocol selection">
                    <option value="http" selected>http</option>
                    <option value="https">https</option>
                </select>
                <label for="protocolSelect">Protocol</label>
            </div>
            <div class="form-floating mb-3">
                <input type="text" id="hostInput" class="form-control" placeholder="Enter Host" />
                <label for="hostInput">Enter Host</label>
            </div>
            <div class="form-floating mb-3">
                <input type="text" id="portInput" class="form-control" placeholder="Enter Port" />
                <label for="portInput">Enter Port</label>
            </div>
            <button id="setBaseUrl" class="btn btn-success">Save</button>

            <div id="statusSpinner" class="d-none my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Connecting ...</p>
            </div>
            <p id="connectionMessage" class="text-danger"></p>

            <div class="form-floating mt-3">
                <select class="form-select form-select-sm" id="qualitySelect" aria-label="Quality selection">
                    <option value="400">Low Quality</option>
                    <option value="600">Good Quality</option>
                    <option value="800">Better Quality</option>
                    <option value="1200">Best Quality</option>
                </select>
                <label for="qualitySelect">Slide Thumbnail Quality</label>
            </div>

            <div class="input-group mt-3">
                <div class="form-floating">
                    <select class="form-select form-select-sm" disabled id="playlistSelect"
                        aria-label="Playlist selection">
                    </select>
                    <label for="playlistSelect">Active Playlist Selection</label>
                </div>
                <input type="checkbox" class="btn-check" checked id="btnPlaylistSelectLock" autocomplete="off">
                <label id="btnPlaylistSelectLockIcon" class="btn d-flex align-items-center justify-content-center"
                    for="btnPlaylistSelectLock">
                    <svg class="bi" height="20" width="20">
                        <use xlink:href="#bi-lock"></use>
                    </svg>
                </label>
            </div>

        </div>
        <div class="offcanvas-footer ms-3">
            <div id="versionInfo" class="d-none mt-2 border-top pt-2">
                <dl class="row">
                    <dt class="col-sm-3">Name:</dt>
                    <dd id="propresenterName" class="col-sm-9"></dd>
                    <dt class="col-sm-3">Description:</dt>
                    <dd id="hostDescription" class="col-sm-9"></dd>
                    <dt class="col-sm-3">Version:</dt>
                    <dd id="apiVersion" class="col-sm-9"></dd>
                </dl>
            </div>
        </div>
    </div>

    <script>

        let isConnected = false;
        let current_presentation = null;
        let slide_index = null;
        let total_slide_count = null;

        // Page load events
        document.addEventListener('DOMContentLoaded', async function () {

            // Set inputs based on local storage if available
            const baseUrl = localStorage.getItem('baseUrl');
            if (baseUrl) {
                const url = new URL(baseUrl);
                document.getElementById('protocolSelect').value = url.protocol.slice(0, -1);
                document.getElementById('hostInput').value = url.hostname;
                document.getElementById('portInput').value = url.port;

                const response = await fetch(`${baseUrl}/version`)
                    .then(response => {
                        if (response.ok) {
                            setConnectedStatus(true);
                        } else {
                            setConnectedStatus(false);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        setConnectedStatus(false);
                    })
                    ;
            }

            // Set qualitySelect based on local storage if available
            const quality = localStorage.getItem('quality');
            if (quality) {
                document.getElementById('qualitySelect').value = quality;
            }

            if (isConnected) {
                document.querySelector('#configButton svg use').setAttribute('xlink:href', '#bi-house-fill');
                document.getElementById('configButtonIcon').classList.add('text-success');
                document.getElementById('configButtonIcon').classList.remove('text-warning');

                await loadListOfPlaylists();
                await loadPlaylist();
            }

            return await monitorStatusUpdates();
        });

        document.getElementById('setBaseUrl').addEventListener('click', async function () {
            const protocol = document.getElementById('protocolSelect').value;
            const host = document.getElementById('hostInput').value;
            const port = document.getElementById('portInput').value;

            const connectionMessage = document.getElementById('connectionMessage');
            connectionMessage.textContent = '';

            if (host && port) {
                const baseUrl = `${protocol}://${host}:${port}`;
                localStorage.setItem('baseUrl', baseUrl);
                console.log('Base URL set to:', baseUrl);

                const statusSpinner = document.getElementById('statusSpinner');

                statusSpinner.classList.remove('d-none');
                const response = await fetch(`${baseUrl}/version`, {
                    method: 'GET',
                })
                    .catch(error => {
                        console.error('Error:', error);
                        statusSpinner.classList.add('d-none');
                        connectionMessage.textContent = 'Failed to connect: ' + error;
                        setConnectedStatus(false);
                    });
                statusSpinner.classList.add('d-none');

                setTimeout(() => {
                    versionInfo.classList.add('d-none');
                }, 5000);

                if (response === undefined) {
                    return;
                }

                if (response.ok) {
                    setConnectedStatus(true);

                    await loadListOfPlaylists();

                    const data = await response.json();
                    console.log('Response:', data);

                    const versionInfo = document.getElementById('versionInfo');
                    versionInfo.classList.remove('d-none');

                    document.getElementById('propresenterName').textContent = data.name;
                    document.getElementById('hostDescription').textContent = data.host_description;
                    document.getElementById('apiVersion').textContent = data.api_version;



                } else {
                    setConnectedStatus(false);
                    connectionMessage.textContent = 'Failed to connect';
                    console.error('Failed to connect');
                }
            }
        });

        document.getElementById('nextButton').addEventListener('click', async function () {
            try {
                const nextSlideIndex = getNextSlideIndex(slide_index);

                if (nextSlideIndex === -1) {
                    return;
                }

                const baseUrl = localStorage.getItem('baseUrl');
                const url = `${baseUrl}/v1/presentation/active/${nextSlideIndex}/trigger`;

                const response = await fetch(url, {
                    method: 'GET',
                });
                if (response.ok) {
                    console.log('Request successful');
                } else {
                    console.error('Request failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.getElementById('previousButton').addEventListener('click', async function () {
            try {
                const previousSlideIndex = getPreviousSlideIndex(slide_index);

                if (previousSlideIndex === -1) {
                    return;
                }

                const baseUrl = localStorage.getItem('baseUrl');
                const url = `${baseUrl}/v1/presentation/active/${previousSlideIndex}/trigger`;
                const response = await fetch(url, {
                    method: 'GET',
                });
                if (response.ok) {
                    console.log('Request successful');
                } else {
                    console.error('Request failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'ArrowLeft') {
                document.getElementById('previousButton').click();
            }

            if (event.key === 'ArrowRight') {
                document.getElementById('nextButton').click();
            }
        });

        document.getElementById('qualitySelect').addEventListener('change', function () {
            const quality = document.getElementById('qualitySelect').value;
            localStorage.setItem('quality', quality);

            if (presentation_id !== null && slide_index !== null) {
                displayCurrentThumbnail(presentation_id, slide_index);
            }
        });

        document.getElementById('presentationList').addEventListener('change', async function () {
            const presentation_id = document.getElementById('presentationList').value;
            //console.log('Presentation Selected:', presentation_id);
            if (!presentation_id) { return; }

            const baseUrl = localStorage.getItem('baseUrl');
            await fetch(`${baseUrl}/v1/presentation/${presentation_id}/trigger`);

            // Re-lock the presentation list after selection
            const btnPresentationListLock = document.getElementById('btnPresentationListLock');
            btnPresentationListLock.checked = true;
            const lockIcon = document.querySelector('#btnPresentationListLockIcon svg use');
            lockIcon.setAttribute('xlink:href', '#bi-lock');
            document.getElementById('presentationList').disabled = true;
            document.getElementById('startNextButton').disabled = true;
        });

        document.getElementById('playlistSelect').addEventListener('change', async function () {
            const playlist_id = document.getElementById('playlistSelect').value;
            if (!playlist_id) { return; }

            const baseUrl = localStorage.getItem('baseUrl');
            const response = await fetch(`${baseUrl}/v1/playlist/${playlist_id}/focus`)
                .then(async response => {
                    return await fetch(`${baseUrl}/v1/playlist/focused/trigger`)
                })
                .catch(error => {
                    console.error('Error:', error);
                });

            if (response.ok) {
                console.log('Triggered playlist successful');
            }
        });

        document.getElementById('btnPlaylistSelectLock').addEventListener('change', function () {
            console.log('Playlist Select Lock:', this.checked);

            const playlistSelect = document.getElementById('playlistSelect');
            // toggle the btnPlaylistselectlockicon between lock and unlock
            const btnPlaylistSelectLock = document.getElementById('btnPlaylistSelectLock');
            const lockIcon = document.querySelector('#btnPlaylistSelectLockIcon svg use');
            if (btnPlaylistSelectLock.checked) {
                lockIcon.setAttribute('xlink:href', '#bi-lock');
                playlistSelect.disabled = true;
            } else {
                lockIcon.setAttribute('xlink:href', '#bi-unlock');
                playlistSelect.disabled = false;
            }
        });

        document.getElementById('btnPresentationListLock').addEventListener('change', function () {
            console.log('Presentation Select Lock:', this.checked);

            const presentationList = document.getElementById('presentationList');
            const btnPresentationListLock = document.getElementById('btnPresentationListLock');
            const lockIcon = document.querySelector('#btnPresentationListLockIcon svg use');

            if (btnPresentationListLock.checked) {
                lockIcon.setAttribute('xlink:href', '#bi-lock');
                presentationList.disabled = true;
                document.getElementById('startNextButton').disabled = true;
            } else {
                lockIcon.setAttribute('xlink:href', '#bi-unlock');
                presentationList.disabled = false;
                document.getElementById('startNextButton').disabled = false;
            }
        });

        document.getElementById('startNextButton').addEventListener('click', async function() {
            const presentationList = document.getElementById('presentationList');
            const currentIndex = presentationList.selectedIndex;
            
            // Check if there's a next presentation
            if (currentIndex < presentationList.options.length - 1) {
                const nextOption = presentationList.options[currentIndex + 1];
                const nextPresentationId = nextOption.value;
                
                // Trigger the next presentation
                const baseUrl = localStorage.getItem('baseUrl');
                await fetch(`${baseUrl}/v1/presentation/${nextPresentationId}/trigger`);
            }
        });

        async function monitorStatusUpdates() {

            console.log('Waiting for connection...');

            while (!isConnected) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            try {
                console.log('Fetching chunked data...');
                const baseUrl = localStorage.getItem('baseUrl');
                const chunkedUrl = `${baseUrl}/v1/status/updates`;
                const response = await fetch(chunkedUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify([
                        "playlist/active",
                        "presentation/active",
                        "presentation/slide_index",
                        "status/slide",
                    ]),
                })
                    .catch(error => {
                        console.error('Error:', error);
                    });

                if (response === undefined || !response.ok) {
                    setConnectedStatus(false);
                    return monitorStatusUpdates();
                }

                const reader = response.body.getReader();
                let decoder = new TextDecoder();
                let data = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    data += decoder.decode(value, { stream: true });

                    const parts = data.split("\r\n\r\n");

                    parts.forEach(part => {
                        if (part.trim()) {

                            const json = JSON.parse(part);

                            const url = json.url;
                            const parsedData = json.data;

                            switch (url) {
                                case 'status/slide':
                                    console.log('Slide Data:', parsedData);
                                    if (parsedData.current) {
                                        const slide = parsedData.current;
                                        const notes = slide.notes;
                                        const text = slide.text;

                                        if (notes) {
                                            document.getElementById('slideNotes').textContent = notes;
                                        } else {
                                            document.getElementById('slideNotes').textContent = text;
                                        }
                                    }

                                    const hasNextSlide = parsedData.next.uuid !== '';
                                    const nextButton = document.getElementById('nextButton');

                                    if (hasNextSlide) {
                                        nextButton.disabled = false;
                                        document.getElementById('startNextButton').disabled = true;
                                    } else if (nextButton.disabled === false) {
                                        document.getElementById('nextSlideThumbnail').classList.add('d-none');
                                        document.getElementById('nextSlideThumbnailPlaceholder').classList.remove('d-none');
                                        nextButton.disabled = true;
                                        document.getElementById('startNextButton').disabled = false;
                                    }

                                    break;

                                case 'presentation/slide_index':
                                    //console.log('Presentation Data:', parsedData);
                                    if (parsedData.presentation_index) {

                                        const index = parsedData.presentation_index.index;
                                        const presentation = parsedData.presentation_index.presentation_id;

                                        // Set the appTitle to the presentationName
                                        const appTitle = document.getElementById('appTitle');
                                        if (appTitle.textContent !== presentation.name) {
                                            appTitle.textContent = presentation.name;
                                        }

                                        document.getElementById('previousButton').disabled = index === 0;

                                        if (current_presentation !== undefined || current_presentation.uuid !== presentation.uuid || slide_index !== index) {
                                            slide_index = index;
                                            displayCurrentThumbnail(presentation.uuid, index);
                                        }
                                    }
                                    break;

                                case 'presentation/active':
                                    console.log('Active Presentation:', parsedData);
                                    if (parsedData.presentation) {
                                        current_presentation = parsedData.presentation;
                                        document.getElementById('presentationList').value = current_presentation.id.uuid;
                                        total_slide_count = getTotalSlides(current_presentation);
                                    }
                                    break;

                                case 'playlist/active':
                                    console.log('Active Playlist:', parsedData);
                                    if (parsedData.presentation.playlist) {
                                        document.getElementById('playlistSelect').value = parsedData.presentation.playlist.uuid;
                                        loadPlaylist(parsedData.presentation.playlist.uuid);
                                    }
                                    break;

                                case 'timer/system_time':
                                    const systemTime = new Date(parsedData * 1000).toLocaleTimeString();
                                    break;

                                default:
                                    console.log('Unknown URL:', url);
                                    console.log('Data:', parsedData);
                                    break;
                            }
                        }
                    });

                    data = '';
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function displayCurrentThumbnail(id, index) {

            const baseUrl = localStorage.getItem('baseUrl');
            const quality = document.getElementById('qualitySelect').value;
            const url = `${baseUrl}/v1/presentation/${id}/thumbnail/${index}?quality=${quality}`;

            await loadThumbnail(url, 'slideThumbnail');
            document.getElementById('slideIndexLabel').textContent = `Slide: ${slide_index + 1} of ${total_slide_count}`;

            const nextIndex = getNextSlideIndex(index);

            if (nextIndex !== -1) {
                const nextUrl = `${baseUrl}/v1/presentation/${id}/thumbnail/${nextIndex}?quality=${quality}`;
                await loadThumbnail(nextUrl, 'nextSlideThumbnail')
                    .catch(error => {
                        if (error.status === 404) {
                            document.getElementById('nextSlideThumbnail').classList.add('d-none');
                            document.getElementById('nextSlideThumbnailPlaceholder').classList.remove('d-none');
                        }
                    });
            }
        }

        async function loadThumbnail(url, elementId) {
            const response = await fetch(url);

            if (response === undefined) {
                return;
            }

            if (response.ok) {
                const blob = await response.blob();
                const imgUrl = URL.createObjectURL(blob);
                document.getElementById(elementId).src = imgUrl;
                document.getElementById(elementId).classList.remove('d-none');

                document.getElementById(`${elementId}Placeholder`).classList.add('d-none');
                console.log('Thumbnail loaded');
            } else {
                document.getElementById(elementId).classList.add('d-none');
                document.getElementById(`${elementId}Placeholder`).classList.remove('d-none');
                console.error('Failed to load thumbnail');
            }
        }

        function getNextSlideIndex(currentIndex) {

            if (current_presentation === null) {
                return -1;
            }

            if (total_slide_count !== null && currentIndex >= total_slide_count - 1) {
                return -1;
            }

            let slideCount = 0;

            for (const group of current_presentation.groups) {
                for (const slide of group.slides) {
                    if (slide.enabled) {
                        if (slideCount > currentIndex) {
                            return slideCount;
                        }
                    }
                    slideCount++;
                }
            }

            // If the current slide is the last one, return -1 indicating no next slide
            return -1;
        }

        function getPreviousSlideIndex(currentIndex) {

            if (current_presentation === null) {
                return -1;
            }

            if (currentIndex <= 0) {
                return -1;
            }

            let slideCount = 0;
            let previousIndex = -1;

            for (const group of current_presentation.groups) {
                for (const slide of group.slides) {
                    if (slide.enabled) {
                        if (slideCount >= currentIndex) {
                            return previousIndex;
                        }
                        previousIndex = slideCount;
                    }
                    slideCount++;
                }
            }

            // If the current slide is the first one, return -1 indicating no previous slide
            return previousIndex;
        }

        function updateNextPresentation() {
            const presentationList = document.getElementById('presentationList');
            const nextPresentation = document.getElementById('nextPresentation');
            const startNextButton = document.getElementById('startNextButton');

            // Find the selected option
            const selectedOption = presentationList.options[presentationList.selectedIndex];

            // If there's a selected option and it's not the last one, show the next presentation
            if (selectedOption && presentationList.selectedIndex < presentationList.options.length - 1) {
                const nextOption = presentationList.options[presentationList.selectedIndex + 1];
                nextPresentation.textContent = nextOption.textContent;
                nextPresentation.classList.remove('text-body-tertiary', 'fst-italic');
            } else {
                nextPresentation.textContent = "End of program";
                nextPresentation.classList.add('text-body-tertiary', 'fst-italic');
                startNextButton.disabled = true;
            }
        }

        function setConnectedStatus(status) {
            isConnected = status;
            const configButtonIcon = document.getElementById('configButtonIcon');
            if (status) {
                document.querySelector('#configButton svg use').setAttribute('xlink:href', '#bi-house-fill');
                configButtonIcon.classList.add('text-success');
                configButtonIcon.classList.remove('text-warning');
            } else {
                document.querySelector('#configButton svg use').setAttribute('xlink:href', '#bi-house-slash');
                configButtonIcon.classList.remove('text-success');
                configButtonIcon.classList.add('text-warning');
            }
        }

        async function loadListOfPlaylists() {
            const baseUrl = localStorage.getItem('baseUrl');
            const playlists = await fetch(`${baseUrl}/v1/playlists`)
                .then(async response => await response.json())
                .catch(error => {
                    console.error('Error:', error);
                });

            if (playlists !== undefined) {
                const playlistSelect = document.getElementById('playlistSelect');

                playlistSelect.appendChild(document.createElement('option'));

                playlists.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.id.uuid;
                    option.textContent = playlist.id.name;
                    playlistSelect.appendChild(option);
                });
            }
        }

        async function loadPlaylist(id) {
            const baseUrl = localStorage.getItem('baseUrl');

            if (id === undefined) {
                const active_playlist = await fetch(`${baseUrl}/v1/playlist/active`)
                    .then(async response => await response.json())
                    .catch(error => {
                        console.error('Error:', error);
                    });

                if (active_playlist && active_playlist.presentation.playlist) {
                    id = active_playlist.presentation.playlist.uuid;
                }
            }

            if (id !== undefined) {

                const presentationList = document.getElementById('presentationList');

                const playlistItems = await fetch(`${baseUrl}/v1/playlist/${id}`)
                    .then(async response => await response.json())
                    .catch(error => {
                        console.error('Error:', error);
                    });

                if (playlistItems !== undefined) {

                    presentationList.innerHTML = '';

                    playlistItems.items.forEach(item => {
                        if (item.type !== 'presentation') {
                            return;
                        }

                        const option = document.createElement('option');
                        option.value = item.id.uuid;
                        option.textContent = item.id.name;
                        option.selected = current_presentation && item.id.uuid === current_presentation.id.uuid;
                        presentationList.appendChild(option);
                    });
                }
            }

            updateNextPresentation();
        }

        function getTotalSlides(jsonData) {
            let totalSlides = 0;

            jsonData.groups.forEach(group => {
                totalSlides += group.slides.length;
            });

            return totalSlides;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"
        onError="this.onError=null;this.src='bootstrap.min.js';"></script>
    <script src="popper.min.js"></script>
</body>

</html>